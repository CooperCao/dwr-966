/* adpBufferFileInit.c - Buffer based file-system  */

/* Copyright (c) 2007, TeamF1, Inc. */

/*
modification history
--------------------

01a,21oct07,san  created.
*/ 

/* includes */
#include "adaptos.h"

/* forward declaration */
LOCAL int createConfigFiles(void);
int dumpFile(char *,unsigned char *,int);
    
/* extern */
extern FILE_STRUCT * pFileBuffer[];

/*
 * <keytab> contains the keys configured on KDC for a service in binary 
 * format. The bin2hex program can be used to convert the binary file to 
 * hexadecimal array used below. 
 */

unsigned char keytab[] = 
    {
    0x5,  0x2,    0,    0,    0, 0x3a,    0,  0x2,
   0,  0xb, 0x45, 0x49, 0x54, 0x2e, 0x48, 0x45,
0x49, 0x4d, 0x44, 0x41, 0x4c,    0,  0x6, 0x73,
0x61, 0x6d, 0x70, 0x6c, 0x65,    0,  0x8, 0x76,
0x78, 0x74, 0x61, 0x72, 0x67, 0x65, 0x74,    0,
   0,    0,  0x1, 0x46, 0x7b, 0x86, 0xed,  0x1,
   0,  0x3,    0,  0x8, 0x58, 0xe6, 0x40, 0xec,
0xd6, 0x8a, 0x29, 0x26,    0,    0,    0,  0x1,
   0,    0,    0, 0x3a,    0,  0x2,    0,  0xb,
0x45, 0x49, 0x54, 0x2e, 0x48, 0x45, 0x49, 0x4d,
0x44, 0x41, 0x4c,    0,  0x6, 0x73, 0x61, 0x6d,
0x70, 0x6c, 0x65,    0,  0x8, 0x76, 0x78, 0x74,
0x61, 0x72, 0x67, 0x65, 0x74,    0,    0,    0,
 0x1, 0x46, 0x7b, 0x86, 0xed,  0x1,    0,  0x2,
   0,  0x8, 0x58, 0xe6, 0x40, 0xec, 0xd6, 0x8a,
0x29, 0x26,    0,    0,    0,  0x1,    0,    0,
   0, 0x3a,    0,  0x2,    0,  0xb, 0x45, 0x49,
0x54, 0x2e, 0x48, 0x45, 0x49, 0x4d, 0x44, 0x41,
0x4c,    0,  0x6, 0x73, 0x61, 0x6d, 0x70, 0x6c,
0x65,    0,  0x8, 0x76, 0x78, 0x74, 0x61, 0x72,
0x67, 0x65, 0x74,    0,    0,    0,  0x1, 0x46,
0x7b, 0x86, 0xed,  0x1,    0,  0x1,    0,  0x8,
0x58, 0xe6, 0x40, 0xec, 0xd6, 0x8a, 0x29, 0x26,
   0,    0,    0,  0x1,    0,    0,    0, 0x52,
   0,  0x2,    0,  0xb, 0x45, 0x49, 0x54, 0x2e,
0x48, 0x45, 0x49, 0x4d, 0x44, 0x41, 0x4c,    0,
 0x6, 0x73, 0x61, 0x6d, 0x70, 0x6c, 0x65,    0,
 0x8, 0x76, 0x78, 0x74, 0x61, 0x72, 0x67, 0x65,
0x74,    0,    0,    0,  0x1, 0x46, 0x7b, 0x86,
0xed,  0x1,    0, 0x12,    0, 0x20, 0xb9, 0x9f,
0x63,  0xd, 0xcd, 0xf9, 0x2f,  0xf, 0x40, 0x8c,
 0x1, 0xb8,  0xe, 0x16, 0x28, 0x34, 0x90, 0xd8,
0xb2, 0xcc, 0xae, 0x43, 0x59,  0x8, 0xd0, 0x23,
0x24, 0xe2, 0xdd, 0x3a, 0x67, 0x59,    0,    0,
   0,  0x1,    0,    0,    0, 0x4a,    0,  0x2,
   0,  0xb, 0x45, 0x49, 0x54, 0x2e, 0x48, 0x45,
0x49, 0x4d, 0x44, 0x41, 0x4c,    0,  0x6, 0x73,
0x61, 0x6d, 0x70, 0x6c, 0x65,    0,  0x8, 0x76,
0x78, 0x74, 0x61, 0x72, 0x67, 0x65, 0x74,    0,
   0,    0,  0x1, 0x46, 0x7b, 0x86, 0xed,  0x1,
   0, 0x10,    0, 0x18, 0x5e, 0xfd, 0x51, 0x5e,
0xa1, 0x20, 0xf4, 0x1c, 0x1c, 0x9d, 0xae, 0x5e,
0x8c, 0xcd, 0xf2, 0xe0, 0xf2, 0xb5, 0x43, 0x40,
0x2a, 0xa8, 0x80, 0xfe,    0,    0,    0,  0x1,
   0,    0,    0, 0x42,    0,  0x2,    0,  0xb,
0x45, 0x49, 0x54, 0x2e, 0x48, 0x45, 0x49, 0x4d,
0x44, 0x41, 0x4c,    0,  0x6, 0x73, 0x61, 0x6d,
0x70, 0x6c, 0x65,    0,  0x8, 0x76, 0x78, 0x74,
0x61, 0x72, 0x67, 0x65, 0x74,    0,    0,    0,
 0x1, 0x46, 0x7b, 0x86, 0xed,  0x1,    0, 0x17,
   0, 0x10, 0x9c, 0x56, 0x46, 0x83, 0x96, 0xb8,
0xbf, 0x2b, 0xc0, 0x4b, 0xb8,  0x1,  0x6, 0x53,
0x4c, 0x36,    0,    0,    0,  0x1,    0,    0,
   0, 0x37,    0,  0x2,    0,  0x8, 0x45, 0x49,
0x54, 0x2e, 0x54, 0x4f, 0x50, 0x4f,    0,  0x6,
0x73, 0x61, 0x6d, 0x70, 0x6c, 0x65,    0,  0x8,
0x76, 0x78, 0x74, 0x61, 0x72, 0x67, 0x65, 0x74,
   0,    0,    0,  0x1, 0x46, 0x7b, 0x8a,  0x6,
 0x1,    0,  0x3,    0,  0x8, 0xb3, 0xbf, 0x68,
 0xb, 0x4a, 0x15, 0xf1, 0x3b,    0,    0,    0,
 0x1,    0,    0,    0, 0x37,    0,  0x2,    0,
 0x8, 0x45, 0x49, 0x54, 0x2e, 0x54, 0x4f, 0x50,
0x4f,    0,  0x6, 0x73, 0x61, 0x6d, 0x70, 0x6c,
0x65,    0,  0x8, 0x76, 0x78, 0x74, 0x61, 0x72,
0x67, 0x65, 0x74,    0,    0,    0,  0x1, 0x46,
0x7b, 0x8a,  0x6,  0x1,    0,  0x2,    0,  0x8,
0xb3, 0xbf, 0x68,  0xb, 0x4a, 0x15, 0xf1, 0x3b,
   0,    0,    0,  0x1,    0,    0,    0, 0x37,
   0,  0x2,    0,  0x8, 0x45, 0x49, 0x54, 0x2e,
0x54, 0x4f, 0x50, 0x4f,    0,  0x6, 0x73, 0x61,
0x6d, 0x70, 0x6c, 0x65,    0,  0x8, 0x76, 0x78,
0x74, 0x61, 0x72, 0x67, 0x65, 0x74,    0,    0,
   0,  0x1, 0x46, 0x7b, 0x8a,  0x6,  0x1,    0,
 0x1,    0,  0x8, 0xb3, 0xbf, 0x68,  0xb, 0x4a,
0x15, 0xf1, 0x3b,    0,    0,    0,  0x1,    0,
   0,    0, 0x4f,    0,  0x2,    0,  0x8, 0x45,
0x49, 0x54, 0x2e, 0x54, 0x4f, 0x50, 0x4f,    0,
 0x6, 0x73, 0x61, 0x6d, 0x70, 0x6c, 0x65,    0,
 0x8, 0x76, 0x78, 0x74, 0x61, 0x72, 0x67, 0x65,
0x74,    0,    0,    0,  0x1, 0x46, 0x7b, 0x8a,
 0x6,  0x1,    0, 0x12,    0, 0x20, 0xbc, 0x5f,
0x41, 0x37, 0xea, 0x87, 0x73, 0x91, 0xc4, 0x60,
 0x8, 0x4e, 0x39, 0x32, 0xdf, 0x39, 0x58,  0x4,
0xfc, 0x6d, 0xff, 0xea, 0xb2, 0x90,    0, 0xec,
0x6d, 0x10, 0xd3, 0x40, 0x45,  0xf,    0,    0,
   0,  0x1,    0,    0,    0, 0x47,    0,  0x2,
   0,  0x8, 0x45, 0x49, 0x54, 0x2e, 0x54, 0x4f,
0x50, 0x4f,    0,  0x6, 0x73, 0x61, 0x6d, 0x70,
0x6c, 0x65,    0,  0x8, 0x76, 0x78, 0x74, 0x61,
0x72, 0x67, 0x65, 0x74,    0,    0,    0,  0x1,
0x46, 0x7b, 0x8a,  0x6,  0x1,    0, 0x10,    0,
0x18, 0x54, 0x5e, 0x8f, 0xf2,  0xd, 0xc2, 0xd6,
0x25, 0xc2, 0x52, 0xb3, 0x85, 0xa4, 0xd5, 0x10,
0xf1, 0xdf, 0x1c, 0xf7, 0x8f, 0x29, 0x68, 0xb6,
0x19,    0,    0,    0,  0x1,    0,    0,    0,
0x3f,    0,  0x2,    0,  0x8, 0x45, 0x49, 0x54,
0x2e, 0x54, 0x4f, 0x50, 0x4f,    0,  0x6, 0x73,
0x61, 0x6d, 0x70, 0x6c, 0x65,    0,  0x8, 0x76,
0x78, 0x74, 0x61, 0x72, 0x67, 0x65, 0x74,    0,
   0,    0,  0x1, 0x46, 0x7b, 0x8a,  0x6,  0x1,
   0, 0x17,    0, 0x10, 0x9c, 0x56, 0x46, 0x83,
0x96, 0xb8, 0xbf, 0x2b, 0xc0, 0x4b, 0xb8,  0x1,
 0x6, 0x53, 0x4c, 0x36,    0,    0,    0,  0x1
    };

/* 
 * <krb5_conf> is the main configuration file for kerberos. This contains the 
 * description of default realm and the ip address of the KDC
 */

unsigned char krb5_conf[] = 
    {
    "[libdefaults]\n"
        "default_realm = EIT.HEIMDAL\n"
	"clockskew = 300\n"
    "[realms]\n"
        "EIT.HEIMDAL = { \n"
            "kdc = 192.168.1.94:888\n"
        "}\n"  
        "KERBEROS.EIT = { \n"
            "kdc = 192.168.1.33\n"
        "}\n"
        "EXAMPLE.COM = { \n"
            "kdc = 192.168.1.94:888\n"
        "}\n"
        "EIT.WINDOWS = { \n"
            "kdc = 192.168.1.227\n"
        "}\n"
    "\n"
    };

/*******************************************************************************
*
* adpBufferFileTableInit - initialize Buffer based file table structre
*                    
*
* This routine allocate memory for buffer based file structure table and 
* intialize files struct member.
* 
* RETURNS:  0 on success and -1 on failure 
*/

int adpBufferFileTableInit(void)
    {
    unsigned int index;
    extern int createConfigFiles(void);
    
    for(index=0;index<MAX_IO_OPENFILES;index++)
        {
        pFileBuffer[index] = (FILE_STRUCT *)malloc(sizeof(FILE_STRUCT));  
        memset(pFileBuffer[index],0,sizeof(FILE_STRUCT *));
        if(pFileBuffer[index] != NULL)
            {	      
            memset(pFileBuffer[index]->fname,0,sizeof(pFileBuffer[index]->fname));
            pFileBuffer[index]->base = NULL;
            pFileBuffer[index]->rptr = NULL;
            pFileBuffer[index]->wptr = NULL;
            pFileBuffer[index]->mode = _UNBUF;
            pFileBuffer[index]->flag = _UNBUF;
	        pFileBuffer[index]->fd   = -1;
            pFileBuffer[index]->file_count = 0;
            }
        else
            return -1;
        }
    createConfigFiles();   
    return 0;
    }

/*******************************************************************************
*
* createConfigFiles - Create Configurtion files. 
*
* This routine Create Configurtion files. 
*
* RETURNS: 0 on success and -1 on failure 
*/

LOCAL int createConfigFiles(void)
    {
    unsigned int retVal;
    retVal = dumpFile("/teamf1/krb/samples/krb5.conf", 
                      krb5_conf, sizeof(krb5_conf));
     if (retVal != 0)
         return retVal;
     retVal = dumpFile("/teamf1/krb/samples/krb5.keytab", 
                       keytab, sizeof(keytab));
     if (retVal != 0)
         return retVal;
     return 0;	
    }

/*******************************************************************************
*
* dumpFile - write data from array to file buffer.
*
* Dump data in to file buffer from array.
*
* RETURNS: 0 on success and -1 on failure 
*/

int dumpFile
    (
    char *fname,
    unsigned char *data,
    int size
    )
    {
    UINT retVal; 
    FILE_STRUCT *fp;
    fp = fopen(fname ,"r+"); 
    if(fp == NULL)
        {
        printf("dumpfile : error in file open \n");
        return -1;
        }  
      retVal = fwrite(data, size,1,fp); 
      fclose(fp); 
      return 0;
    }



